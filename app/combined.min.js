/*
 * WeNomYou
 * Project dependencies for the WeNomYou project
 * @author Jay Huang, Daniel Engelhard, Enoch Yip
 * @version 0.0.0
 * License: BSD-2-Clause
 */

"use strict";function debug(bool){bool?console=holdconsole:(holdconsole=console,console={},console.log=function(){})}var holdconsole=console;debug(!1);var app=angular.module("WeNomYou",["ngRoute","ui.bootstrap","textAngular","angularFileUpload","ngQuickDate","angularMoment","restangular","ipCookie","angular-loading-bar"]);app.constant("API_URL",{url:"http://apitest.younom.me",loc:"/apiservice.svc/"}),app.constant("USER_ROLES",{user:"0",admin:"1"}),app.run(function($rootScope,$route,$location,$templateCache){$rootScope.$on("$routeChangeStart",function(event,next,current){"undefined"!=typeof current&&$templateCache.remove(current.templateUrl)}),$rootScope.site_title="WeNomYou",$rootScope.$on("$routeChangeSuccess",function(){$rootScope.page_title=angular.isUndefined($route.current.title)?$rootScope.site_title:$route.current.title+" | "+$rootScope.site_title})}),app.factory("authHttpInterceptor",function($q,$location,$injector){return{request:function(config){var User=$injector.get("UserService");return"login"!==$location.path().split("/")[1]&&(config.headers["X-Auth-Token"]=User.auth_token),config},responseError:function(response){var User=$injector.get("UserService");return 401===response.status&&"invalid_auth_token"===response.data.code&&User.setLoggedOut(),$q.reject(response)}}}),app.config(function($routeProvider,$httpProvider,$locationProvider,RestangularProvider,API_URL){$httpProvider.interceptors.push("authHttpInterceptor"),$locationProvider.html5Mode(!0),RestangularProvider.setBaseUrl(API_URL.url+API_URL.loc),$routeProvider.when("/",{templateUrl:"views/index.html",controller:"HomeCtrl"}).when("/register",{templateUrl:"views/login-register.html",title:"Register"}).when("/login",{templateUrl:"views/login-register.html",title:"Login"}).when("/start",{templateUrl:"views/create-challenge.html",controller:"CreateChallengeCtrl",title:"Challenge Creation"}).when("/continue",{templateUrl:"views/create-challenge.html",controller:"CreateChallengeCtrl",title:"Continue Challenge Creation"}).when("/challenge/:challengeid/:challengename?",{templateUrl:"views/challenge.html",controller:"ChallengeCtrl",title:"View Campaign"}).when("/profile",{templateUrl:"views/edit-profile.html",controller:"ProfileCtrl",title:"View Campaign"}).when("/explore",{templateUrl:"views/explore.html",controller:"ExploreCtrl",title:"Explore Challenges",reloadOnSearch:!1}).when("/admin",{templateUrl:"views/admin.html",controller:"AdminCtrl",title:"Administration"}).otherwise({redirectTo:"/"})}),app.controller("MainCtrl",function($scope,API_URL,$rootScope,$location,UserService,$timeout,Restangular,APIAuth,USER_ROLES){$rootScope.curruser=$scope.User=UserService,$rootScope.challenges=$rootScope.challenges||[],$scope.$watch(function(){return $location.path()},function(newValue){UserService.isLoggedIn()?("admin"==newValue.split("/")[1]&&$rootScope.curruser.user_level!=USER_ROLES.admin&&$location.path("/"),("login"==newValue.split("/")[1]||"register"==newValue.split("/")[1])&&$location.path("/")):"login"!=newValue.split("/")[1]&&"register"!=newValue.split("/")[1]&&"explore"!=newValue.split("/")[1]&&"challenge"!=newValue.split("/")[1]&&$location.path("/login")})}),app.controller("AdminCtrl",function($scope,APIUser){APIUser.getUsers().then(function(success){$scope.users=success.data},function(fail){console.log(fail)}),$scope.toggleDisabled=function(user){user.disabled?APIUser.enableUser(user.id).then(function(){user.disabled=0}):APIUser.disableUser(user.id).then(function(){user.disabled=1})},$scope.delete=function(user){APIUser.deleteUser(user.id).then(function(){var index=$scope.users.indexOf(user);$scope.users.splice(index,1)})}}),app.factory("APIAuth",function(Restangular){return{getUser:function(){return Restangular.all("getUsers").getList()},register:function(userObj){return Restangular.one("register").customPOST(userObj)},login:function(credsObj){return Restangular.one("login").customPOST(credsObj)}}}),app.factory("APIChallenge",function(Restangular){return{getChallenges:function(){return Restangular.one("getChallenges").customGET()},getChallenge:function(id){return Restangular.one("getChallenge").customGET(id)},createChallenge:function(challengeObj){return Restangular.one("createChallenge").customPOST(challengeObj)},pledge:function(id,amount){return Restangular.one("makePledge").customPOST({id:id,amount:amount})},getChallengePledges:function(id){return Restangular.one("getChallengePledges").customGET(id)}}}),app.factory("APIUser",function(Restangular){return{getUsers:function(){return Restangular.one("getUsers").customGET()},getUser:function(id){return Restangular.one("getUser").customGET(id)},disableUser:function(id){return Restangular.one("changeUserStatus").customPOST({id:id,enabled:"false"})},enableUser:function(id){return Restangular.one("changeUserStatus").customPOST({id:id,enabled:"true"})},updateUser:function(userObj){return Restangular.one("editUser").customPOST(userObj)},deleteUser:function(id){return Restangular.one("deleteUser").customPOST({id:id})}}}),app.controller("ChallengeCtrl",function($routeParams,$scope,$rootScope,APIChallenge,APIUser){function initAuthor(){APIUser.getUser($scope.challenge.nominator).then(function(success){$scope.nominator=success.data})}function updatePledges(){APIChallenge.getChallengePledges($scope.challenge.id).then(function(success){$scope.pledges=success.data,convertDates()})}function convertDates(){$scope.pledges.forEach(function(pledge){pledge.created_date=new Date(pledge.created_date)})}$scope.pledged=!1,APIChallenge.getChallenge($routeParams.challengeid).then(function(success){$scope.challenge=success.data,$rootScope.page_title=angular.isUndefined($scope.challenge.name)?$rootScope.site_title:$scope.challenge.name+" - "+$rootScope.site_title,initAuthor(),updatePledges()},function(fail){console.log(fail)}),$scope.dateInPast=function(value){return moment(value)<moment(new Date)},$scope.pledge=function(id,amount){id&&amount&&APIChallenge.pledge(id,amount).then(function(success){$scope.pledged=!0,$scope.challenge.funded_amount=success.data,updatePledges()})}}),app.controller("CreateChallengeCtrl",function($scope,CreateChallengeService,APIAuth,$timeout,$rootScope,APIChallenge){$scope.challenge||CreateChallengeService.init(),$scope.challenge=CreateChallengeService,$scope.momentAdd=function(value,add,unit,format){return add=add||0,unit=unit||"days",format=format||"MMM DD YYYY",moment(value).add(add,unit).format(format)},$scope.saveData=function($event){var invalid_elements=$("form, ng-form").find(".ng-invalid,.has-error");return invalid_elements.length>0?void($event&&($event.preventDefault(),$event.stopPropagation())):void APIChallenge.createChallenge($scope.challenge).then(function(){})},$scope.onFileSelect=function($files){$scope.selectedFiles=[],$scope.dataUrls=[];for(var i=0;i<$files.length;i++){var $file=$files[i];if($file.type.indexOf("image")>-1){var fileReader=new FileReader;fileReader.readAsDataURL($files[i]);{(function(fileReader,index){fileReader.onload=function(e){$timeout(function(){$scope.challenge.picture=$scope.dataUrls[index]=e.target.result})}})(fileReader,i)}}}},$scope.noPastDates=function(d){var today=new Date;return today.setHours(0),today.setMinutes(0),today.setSeconds(0),today.setMilliseconds(0),d>=today}}),app.service("CreateChallengeService",function($location,$rootScope){var Challenge={id:"",status:"",name:"",picture:"",created:"",description:"",nominee:"",goal:"0",funded_amount:"0",start_date:"",challenge_length:"",ends:"",init:function(){var origVals={};for(var prop in this)this.hasOwnProperty(prop)&&"origVals"!=prop&&(origVals[prop]=this[prop]);this.origVals=origVals},reset:function(){for(var prop in this.origVals)this[prop]=this.origVals[prop]}};return Challenge.enforceFormProgress=function(){function maybeBackToStart(){Challenge.id||"/start"==$rootScope.currentUrl||$location.path("start")}$rootScope.currentUrl=$location.path(),maybeBackToStart(),$rootScope.$on("$locationChangeStart",function(){maybeBackToStart()})},Challenge}),app.directive("numbersOnly",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(inputValue){if(void 0==inputValue)return"";var transformedInput=inputValue.replace(/[^0-9]/g,"");return transformedInput!=inputValue&&(modelCtrl.$setViewValue(transformedInput),modelCtrl.$render()),transformedInput})}}}),app.filter("inArray",function($filter){return function(list,arrayFilter,element){return arrayFilter?$filter("filter")(list,function(listItem){return-1!=arrayFilter.indexOf(listItem[element])}):void 0}}),app.filter("formatDate",function(){return function(input,formatting){return moment(input).format(formatting)}}),app.filter("fromNow",function(){return function(input){return moment(input).fromNow()}}),app.directive("365Only",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(inputValue){if(void 0==inputValue)return"";var transformedInput=inputValue.replace(/[^0-9]/g,"")>365?"365":inputValue.replace(/[^0-9]/g,"");return transformedInput!=inputValue&&(modelCtrl.$setViewValue(transformedInput),modelCtrl.$render()),transformedInput})}}}),app.directive("keyboardPoster",function($parse,$timeout){var DELAY_BEFORE_FIRING=100;return function(scope,elem,attrs){var element=angular.element(elem)[0],currentTimeout=null;element.oninput=function(){var model=$parse(attrs.postFunction),poster=model(scope);currentTimeout&&$timeout.cancel(currentTimeout),currentTimeout=$timeout(function(){poster(angular.element(element).val())},DELAY_BEFORE_FIRING)}}}),app.directive("accessibleForm",function(){return{scope:!0,link:function(scope,element,attrs){var form=scope[attrs.name];element.bind("click",function(){var field=null;for(field in form)form[field].hasOwnProperty("$pristine")&&form[field].$pristine&&(form[field].$dirty=!0);var invalid_elements=$("form, ng-form").find(".ng-invalid,.has-error");invalid_elements.length>0&&$("html,body").animate({scrollTop:$(invalid_elements[0]).offset().top},500,function(){invalid_elements[0].focus()})})}}}),app.directive("dropdown",function($timeout){return{restrict:"C",link:function(scope,elm,attr){$timeout(function(){$(elm).dropdown({debug:!1}).dropdown("setting",{onChange:function(value){scope.$parent[attr.ngModel]=value,scope.$parent.$apply()}})},0)}}}),app.directive("match",function(){return{require:"ngModel",restrict:"A",scope:{match:"="},link:function(scope,elem,attrs,ctrl){scope.$watch("match",function(){ctrl.$validate()}),ctrl.$validators.match=function(modelValue){return ctrl.$pristine&&(angular.isUndefined(modelValue)||""===modelValue)||modelValue===scope.match}}}}),app.filter("noFractionCurrency",["$filter","$locale",function(filter,locale){var currencyFilter=filter("currency"),formats=locale.NUMBER_FORMATS;return function(amount,currencySymbol){var value=currencyFilter(amount,currencySymbol);if(value){var sep=value.indexOf(formats.DECIMAL_SEP);return amount>=0?value.substring(0,sep):value.substring(0,sep)+")"}return amount}}]),app.filter("formatDate",function(){return function(input,formatting){return moment(input).format(formatting)}}),app.controller("ExploreCtrl",function($scope,$routeParams,$location,Restangular,$rootScope,API_URL,APIChallenge){function filterChallenges(){updateFilteredIds()}function updateFilteredIds(){$scope.filteredIds=[];var challengeval=$scope.sortOrFilters.filters.challenge||"",nomineeval=$scope.sortOrFilters.filters.nominee||"";$scope.challenges.forEach(function(challenge){isMatch(challengeval,challenge.name)&&isMatch(nomineeval,challenge.nominee)&&$scope.filteredIds.push(challenge.id)})}function isMatch(searchVal,searchData){return searchVal?searchData?(searchVal=searchVal.replace(/\s+/g," ").toLowerCase(),searchData=searchData.replace(/\s+/g," ").toLowerCase(),!!~searchData.indexOf(searchVal)):!1:!0}function updateURL(){$location.search("nominee",$scope.sortOrFilters.filters.nominee||null),$location.search("challenge",$scope.sortOrFilters.filters.challenge||null)}function processParams(){$scope.sortOrFilters.filters.challenge=$routeParams.challenge||$scope.sortOrFilters.filters.challenge,$scope.sortOrFilters.filters.nominee=$routeParams.nominee||$scope.sortOrFilters.filters.nominee,$scope.filterchallengename=$scope.sortOrFilters.filters.challenge,$scope.filternomineename=$scope.sortOrFilters.filters.nominee}var placeholderchallenges;$scope.sortOrFilters={sort:"",filters:{nominee:"",challenge:""}},processParams(),APIChallenge.getChallenges().then(function(success){placeholderchallenges=success.data,$rootScope.challenges=placeholderchallenges,$scope.challenges=$rootScope.challenges,filterChallenges(),console.log(success.data)},function(fail){console.log(fail)}),$scope.updateSort=function(sort){$scope.sortOrFilters.sort=sort?sort:""},$scope.searchChallenge=function(term){$scope.sortOrFilters.filters.challenge=term?term:"",filterChallenges()},$scope.searchNominee=function(term){$scope.sortOrFilters.filters.nominee=term?term:"",filterChallenges()},$scope.$watch("[sortOrFilters.sort, sortOrFilters.filters]",function(newVal,oldVal){angular.equals(newVal,oldVal)||updateURL()},!0)}),app.controller("HomeCtrl",function($scope){$scope.hi="Hello"}),app.controller("LoginCtrl",function($scope,UserService,$rootScope,$location,APIAuth){$scope.login=function(){$scope.formData||UserService.init(),$scope.formData=$scope.formData?$scope.formData:UserService,$scope.formData.errors=[],APIAuth.login($scope.formData).then(function(success){UserService.setLoggedIn(success.data),console.log(success.data)},function(fail){console.log(fail.data),$scope.formData.errors.push({message:"Invalid credentials, try again"})})}}),app.controller("RegCtrl",function($scope,UserService,$rootScope,APIAuth){$scope.createAccount=function(){$scope.formData||UserService.init(),$scope.formData=$scope.formData?$scope.formData:UserService,APIAuth.register($scope.formData).then(function(){$scope.formData.successful={message:"Account created, please login now!"}},function(fail){console.log(fail.data)}),$scope.register_form.$setUntouched(),UserService.reset()}}),app.controller("NavCtrl",function($scope,CreateChallengeService,$location){$scope.campaign=CreateChallengeService,$scope.isActive=function(viewLocation){return 0==$location.path().indexOf(viewLocation)}}),app.controller("ProfileCtrl",function($scope,$rootScope,$timeout,Restangular,UserService,APIUser){function copyNotValues(obj){var newObj=angular.copy(obj);for(prop in newObj)newObj.hasOwnProperty(prop)&&(newObj[prop]="");return newObj}$scope.user=$rootScope.curruser,$scope.newuser=copyNotValues(UserService),$scope.newpass=[],$scope.saveData=function($event){var invalid_elements=$("form, ng-form").find(".ng-invalid,.has-error");return invalid_elements.length>0?void($event&&($event.preventDefault(),$event.stopPropagation())):($scope.newuser.password="google",void APIUser.updateUser($scope.newuser).then(function(success){UserService.updateUserData(success.data),console.log(success.data)},function(fail){console.log(fail)}))},$scope.onFileSelect=function($files){$scope.selectedFiles=[],$scope.dataUrls=[];for(var i=0;i<$files.length;i++){var $file=$files[i];if($file.type.indexOf("image")>-1){var fileReader=new FileReader;fileReader.readAsDataURL($files[i]);{(function(fileReader,index){fileReader.onload=function(e){$timeout(function(){$scope.newuser.picture=$scope.dataUrls[index]=e.target.result})}})(fileReader,i)}}}}}),app.service("UserService",function($location,$http,ipCookie,Restangular,$timeout,$rootScope){function copyObjectProperties(srcObj,destObj){for(var key in srcObj)"picture"!=key?destObj[key]=srcObj[key]:srcObj[key]=""}$rootScope.curruser=$rootScope.curruser?$rootScope.curruser:{};var User={email:"",first_name:"",last_name:"",auth_token:"",about:"",picture:""};return User.init=function(){var origVals={};for(var prop in this)this.hasOwnProperty(prop)&&"origVals"!=prop&&(origVals[prop]=this[prop]);this.origVals=origVals},User.reset=function(){for(var prop in this.origVals)this[prop]=this.origVals[prop]},User.updateUserData=function(data){return data?(copyObjectProperties(data,User),void ipCookie("wenomyou.user",User,{expires:60,expirationUnit:"minutes"})):!1},User.isLoggedIn=function(){return ipCookie("wenomyou.user")?(copyObjectProperties(ipCookie("wenomyou.user"),$rootScope.curruser),!!$rootScope.curruser.auth_token):!1},User.setLoggedIn=function(data){return(data=data||ipCookie("wenomyou.user"))?(copyObjectProperties(data,User),console.log(ipCookie("wenomyou.user",data,{expires:60,expirationUnit:"minutes"})),$rootScope.curruser=angular.copy(User),$location.path("/explore"),!0):!1},User.setLoggedOut=function(){ipCookie.remove("wenomyou.user"),$rootScope.curruser=0,$location.path("/login")},User});