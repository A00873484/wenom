/*
 * WeNomYou
 * Project dependencies for the WeNomYou project
 * @author Jay Huang, Daniel Engelhard, Enoch Yip
 * @version 0.0.0
 * License: BSD-2-Clause
 */

"use strict";var app=angular.module("WeNomYou",["ngRoute","ui.bootstrap","textAngular","angularFileUpload","ngQuickDate","angularMoment","restangular","ipCookie"]);app.constant("API_URL",{url:"http://apitest.younom.me",loc:"/api/"}),app.run(function($rootScope,$route,$location,$templateCache){$rootScope.$on("$routeChangeStart",function(event,next,current){"undefined"!=typeof current&&$templateCache.remove(current.templateUrl)}),$rootScope.site_title="WeNomYou",$rootScope.$on("$routeChangeSuccess",function(){$rootScope.page_title=angular.isUndefined($route.current.title)?$rootScope.site_title:$route.current.title+" | "+$rootScope.site_title})}),app.config(function($routeProvider,$locationProvider,RestangularProvider,API_URL){$locationProvider.html5Mode(!0),RestangularProvider.setBaseUrl(API_URL.url+API_URL.loc),$routeProvider.when("/",{templateUrl:"views/index.html",controller:"HomeCtrl"}).when("/register",{templateUrl:"views/login-register.html",title:"Register"}).when("/login",{templateUrl:"views/login-register.html",title:"Login"}).when("/start",{templateUrl:"views/create-challenge.html",controller:"CreateChallengeCtrl",title:"Challenge Creation"}).when("/continue",{templateUrl:"views/create-challenge.html",controller:"CreateChallengeCtrl",title:"Continue Challenge Creation"}).when("/continue",{templateUrl:"views/create-challenge.html",controller:"CreateChallengeCtrl",title:"Continue Challenge Creation"}).when("/explore",{templateUrl:"views/explore.html",controller:"ExploreCtrl",title:"Explore Challenges"}).otherwise({redirectTo:"/"})}),app.factory("RestFullResponse",function(Restangular){return Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setFullResponse(!0)})}),app.controller("MainCtrl",function($scope,API_URL,$rootScope,UserService){$scope.User=UserService,window.a=$rootScope.challenges=$rootScope.challenges||[],window.b=$rootScope.users=$rootScope.users||[],$rootScope.users.push({auth_token:"FAKEDATADELETE",email:"jay@jayhuang.org",first_name:"Jay",password:"google",password_confirm:"google"})}),app.factory("APIAuth",function(Restangular){return{getUser:function(userid){return Restangular.one("users",userid).get()}}}),app.controller("CreateChallengeCtrl",function($scope,CreateChallengeService,APIAuth,$timeout,$rootScope){$scope.challenge||CreateChallengeService.init(),$scope.challenge=CreateChallengeService,$rootScope.challenges.length&&($scope.challenge.id=parseInt($rootScope.challenges[$rootScope.challenges.length-1].id)+1),$scope.momentAdd=function(value,add,unit,format){return add=add||0,unit=unit||"days",format=format||"MMM DD YYYY",moment(value).add(add,unit).format(format)},$scope.saveData=function($event){var invalid_elements=$("form, ng-form").find(".ng-invalid,.has-error");return invalid_elements.length>0?void($event&&($event.preventDefault(),$event.stopPropagation())):void $rootScope.challenges.push(angular.copy($scope.challenge))},$scope.onFileSelect=function($files){$scope.selectedFiles=[],$scope.dataUrls=[];for(var i=0;i<$files.length;i++){var $file=$files[i];if($file.type.indexOf("image")>-1){var fileReader=new FileReader;fileReader.readAsDataURL($files[i]);{(function(fileReader,index){fileReader.onload=function(e){$timeout(function(){$scope.challenge.image=$scope.dataUrls[index]=e.target.result})}})(fileReader,i)}}}},$scope.noPastDates=function(d){var today=new Date;return today.setHours(0),today.setMinutes(0),today.setSeconds(0),today.setMilliseconds(0),d>=today}}),app.service("CreateChallengeService",function($location,$rootScope){var Challenge={id:"",status:"",name:"",image:"",created:"",description:"",nominee:"",goal:"0",funded_amount:"0",start_date:"",duration:"",end_date:"",init:function(){var origVals={};for(var prop in this)this.hasOwnProperty(prop)&&"origVals"!=prop&&(origVals[prop]=this[prop]);this.origVals=origVals},reset:function(){for(var prop in this.origVals)this[prop]=this.origVals[prop]}};return Challenge.enforceFormProgress=function(){function maybeBackToStart(){Challenge.id||"/start"==$rootScope.currentUrl||$location.path("start")}$rootScope.currentUrl=$location.path(),maybeBackToStart(),$rootScope.$on("$locationChangeStart",function(){maybeBackToStart()})},Challenge}),app.directive("numbersOnly",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(inputValue){if(void 0==inputValue)return"";var transformedInput=inputValue.replace(/[^0-9]/g,"");return transformedInput!=inputValue&&(modelCtrl.$setViewValue(transformedInput),modelCtrl.$render()),transformedInput})}}}),app.directive("365Only",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(inputValue){if(void 0==inputValue)return"";var transformedInput=inputValue.replace(/[^0-9]/g,"")>365?"365":inputValue.replace(/[^0-9]/g,"");return transformedInput!=inputValue&&(modelCtrl.$setViewValue(transformedInput),modelCtrl.$render()),transformedInput})}}}),app.directive("accessibleForm",function(){return{scope:!0,link:function(scope,element,attrs){var form=scope[attrs.name];element.bind("click",function(){var field=null;for(field in form)form[field].hasOwnProperty("$pristine")&&form[field].$pristine&&(form[field].$dirty=!0);var invalid_elements=$("form, ng-form").find(".ng-invalid,.has-error");invalid_elements.length>0&&$("html,body").animate({scrollTop:$(invalid_elements[0]).offset().top},500,function(){invalid_elements[0].focus()})})}}}),app.directive("dropdown",function($timeout){return{restrict:"C",link:function(scope,elm,attr){$timeout(function(){$(elm).dropdown({debug:!1}).dropdown("setting",{onChange:function(value){scope.$parent[attr.ngModel]=value,scope.$parent.$apply()}})},0)}}}),app.directive("match",function(){return{require:"ngModel",restrict:"A",scope:{match:"="},link:function(scope,elem,attrs,ctrl){scope.$watch("match",function(){ctrl.$validate()}),ctrl.$validators.match=function(modelValue){return ctrl.$pristine&&(angular.isUndefined(modelValue)||""===modelValue)||modelValue===scope.match}}}}),app.controller("ExploreCtrl",function($scope,$routeParams,$location,Restangular,$rootScope){function updateURL(){}$scope.sortOrFilters={sort:"",filters:{category:{},location:"",title:""},page_entries:30,page_limit:100,pagination:{},page:null};var placeholderchallenges=[{id:"1",name:"ALS ice bucket challenge",created:"Sat Oct 25 2014 00:55:23 GMT-0700 (Pacific Daylight Time)",image:"",description:"Description",funded_amount:"19",goal:"50"},{id:"2",name:"Swim in a volcano",created:"Wed Oct 29 2014 00:55:23 GMT-0700 (Pacific Daylight Time)",image:"",description:"Description",funded_amount:"50000",goal:"30000000"},{id:"3",name:"Ask a white girl to coffee!!!",created:"Fri Oct 24 2014 00:55:23 GMT-0700 (Pacific Daylight Time)",image:"",description:"Description",funded_amount:"880000",goal:"1000000"},{id:"4",name:"Super cool challenge",created:"Wed Oct 15 2014 00:55:23 GMT-0700 (Pacific Daylight Time)",image:"",description:"Description",funded_amount:"5",goal:"99"}];$rootScope.challenges.length<=1&&placeholderchallenges.forEach(function(challenge){$rootScope.challenges.push(challenge)}),$scope.challenges=$rootScope.challenges,$scope.updateCategoryFilters=function(category){if("boolean"==typeof category){for(var property in $scope.sortOrFilters.filters.category)$scope.sortOrFilters.filters.category[property]=category;$scope.sortOrFilters.page=1}else category&&($scope.sortOrFilters.filters.category[category]=!$scope.sortOrFilters.filters.category[category],$scope.sortOrFilters.page=1)},$scope.updateSort=function(sort){$scope.sortOrFilters.sort=sort?sort:""},$scope.getTotalItems=function(){var desiredtotal=$scope.sortOrFilters.pagination.entriesperpage*$scope.sortOrFilters.page_limit;return desiredtotal>$scope.sortOrFilters.pagination.totalentries?$scope.sortOrFilters.pagination.totalentries:desiredtotal},$scope.searchTitles=function(term){$scope.sortOrFilters.filters.title=term?term:""},$scope.$watch("sortOrFilters.page",function(newVal,oldVal){newVal!==oldVal&&(updateURL(),updateCampaignListing($scope.sortOrFilters))}),$scope.$watch("[sortOrFilters.sort, sortOrFilters.filters]",function(newVal,oldVal){angular.equals(newVal,oldVal)||(updateURL(),updateCampaignListing($scope.sortOrFilters))},!0)}),app.controller("HomeCtrl",function($scope){$scope.hi="Hello"}),app.controller("LoginCtrl",function($scope,UserService,$rootScope){$scope.login=function(){return $scope.formData||UserService.init(),$scope.formData=$scope.formData?$scope.formData:UserService,$scope.formData.errors=[],$rootScope.users.length?($rootScope.users.forEach(function(user){user.email==$scope.formData.email&&user.password==$scope.formData.password&&UserService.setLoggedIn(user)}),void $scope.formData.errors.push({message:"Invalid credentials, try again"})):void $scope.formData.errors.push({message:"Please register first"})}}),app.controller("RegCtrl",function($scope,UserService,$rootScope){$scope.createAccount=function(){$scope.formData||UserService.init(),$scope.formData=$scope.formData?$scope.formData:UserService,$scope.formData=$scope.formData?$scope.formData:UserService,$scope.formData.auth_token="FAKEDATADELETE",$rootScope.users.push(angular.copy($scope.formData)),$scope.register_form.$setUntouched(),$scope.formData.successful={message:"Account created, please login now!"},UserService.reset()}}),app.controller("CampaignStatusCtrl",function($scope,CreateChallengeService){$scope.campaign=CreateChallengeService}),app.service("UserService",function($location,$http,ipCookie,Restangular,$timeout,$rootScope){function copyObjectProperties(srcObj,destObj){for(var key in srcObj)destObj[key]=srcObj[key]}var User={email:"",first_name:"",last_name:"",auth_token:""};return User.init=function(){var origVals={};for(var prop in this)this.hasOwnProperty(prop)&&"origVals"!=prop&&(origVals[prop]=this[prop]);this.origVals=origVals},User.reset=function(){for(var prop in this.origVals)this[prop]=this.origVals[prop]},User.updateUserData=function(data){return data?(copyObjectProperties(data,User),void ipCookie("wenomyou.user",User,{expires:239,expirationUnit:"minutes"})):!1},User.isLoggedIn=function(){return window.user=$rootScope.curruser=$rootScope.curruser?$rootScope.curruser:{},ipCookie("wenomyou.user")?(copyObjectProperties(ipCookie("wenomyou.user"),$rootScope.curruser),!!$rootScope.curruser.auth_token):!1},User.setLoggedIn=function(data){return(data=data||ipCookie("wenomyou.user"))?(copyObjectProperties(data,User),ipCookie("wenomyou.user",data,{expires:239,expirationUnit:"minutes"}),$rootScope.curruser=angular.copy(data),$location.path("/explore"),!0):!1},User.setLoggedOut=function(){ipCookie.remove("wenomyou.user"),$rootScope.curruser=0,$location.path("/login")},User});